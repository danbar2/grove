name: Validate PR Issue References

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-pr-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read

    steps:
      - name: Validate PR references at least one open issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const prBody = context.payload.pull_request.body || '';

            // Issue reference pattern: #123
            const issuePattern = /#(\d+)/g;

            // Find all issue references in PR description
            const matches = [...prBody.matchAll(issuePattern)];
            const issueNumbers = matches.map(m => parseInt(m[1])).filter(Boolean);

            if (issueNumbers.length === 0) {
              core.setFailed('❌ PR description must reference at least one issue.\n\n' +
                'Please add an issue reference to your PR description using the format: #123');
              return;
            }

            console.log(`Found ${issueNumbers.length} issue reference(s): ${[...new Set(issueNumbers)].map(n => `#${n}`).join(', ')}`);

            // Validate each referenced issue
            let hasValidIssue = false;
            const errors = [];

            for (const issueNumber of [...new Set(issueNumbers)]) {
              try {
                const issue = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber,
                });

                // Check if issue is open
                if (issue.data.state === 'closed') {
                  errors.push(`❌ Issue #${issueNumber} is closed`);
                } else if (issue.data.state_reason === 'completed') {
                  errors.push(`❌ Issue #${issueNumber} is marked as Done/Completed`);
                } else {
                  // Found at least one valid open issue
                  hasValidIssue = true;
                  console.log(`✅ Issue #${issueNumber} is open - validation passed`);
                  break;
                }
              } catch (error) {
                if (error.status === 404) {
                  errors.push(`❌ Issue #${issueNumber} does not exist`);
                } else {
                  errors.push(`❌ Issue #${issueNumber}: ${error.message}`);
                }
              }
            }

            // Report results
            if (!hasValidIssue) {
              const issueList = [...new Set(issueNumbers)].map(n => `#${n}`).join(', ');
              core.setFailed(
                `❌ PR references ${issueList}, but none are open issues.\n\n` +
                errors.join('\n') + '\n\n' +
                'Please reference at least one open (not closed or Done) issue in your PR description.'
              );
            } else {
              console.log('✅ PR references at least one open issue - validation passed');
            }
